"use strict";class libmusicxml{constructor(){this.fLibrary=0}initialize(i){if("undefined"!=typeof process&&"node"===process.release.name){var r=require(i);return new Promise(i=>{r().then(r=>{this.moduleInit(r),i(this)})})}r=MusicXMLModule();return new Promise((i,e)=>{r.onRuntimeInitialized=()=>{this.moduleInit(r),i(this)}})}moduleInit(i){this.fLibrary=new i.libMusicXMLAdapter}libVersion(){return this.fLibrary.libVersion()}libVersionStr(){return this.fLibrary.libVersionStr()}musicxml2guidoVersion(){return this.fLibrary.musicxml2guidoVersion()}musicxml2guidoVersionStr(){return this.fLibrary.musicxml2guidoVersionStr()}string2guido(i,r){return this.fLibrary.string2guido(i,r)}xmlStringTranspose(i,r){return this.fLibrary.xmlStringTranspose(i,r)}}"undefined"!=typeof process&&"node"===process.release.name&&(module.exports=libmusicxml);
function load(e,t){t&&fetch("./"+t).then(e=>e.text()).then(e=>{guidoEditor.setGmn(e,t)})}fetch("./examples.json").then(e=>e.json()).then(e=>{const t=$("#tab-examples"),a=(e,t)=>{if("file"===e.type){const a=$("<a>").attr("href","#").text(e.name).data("path",e.path);t.append($("<li>").append(a)),a.on("click",t=>{load(e.name,e.path)})}else{const n=$("<li>").addClass(["dropdown-submenu"]),d=$("<a>").attr("href","#").text(e.name).on("click",e=>{e.stopImmediatePropagation()}),o=$("<ul>").addClass("dropdown-menu");n.append(d,o),e.children.forEach(e=>a(e,o)),t.append(n),d.dropdown()}};e.children&&e.children.forEach(e=>a(e,t))});
!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../node_modules/codemirror/lib/codemirror")):"function"==typeof define&&define.amd?define(["../node_modules/codemirror/lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";e.defineMode("guido",function(){var e=/[a-zA-Z]+/,n=/[abcdefgh]/,t=/do|re|mi|fa|sol|la|si|cis|dis|fis|ais/;return{startState:function(){var e={inComment:!1,inString:!1};return e},token:function(i,o){return i.eatSpace()?null:function(i,o){if(i.match(t,!0)&&!o.inComment)return"def";var r=i.next();return"%"==r?(i.skipToEnd(),"comment"):"\\"==r&&i.match(e,!0)?"keyword":o.inComment?("*"==r&&")"==i.peek()&&(o.inComment=!1),"comment"):"("==r&&"*"==i.peek()?(o.inComment=!0,"comment"):o.inString?('"'==r&&(o.inString=!1),"string"):'"'==r?(o.inString=!0,"string"):r.match(n,!0)?"def":r.match(/[()<>{}]/)?"bracket":r.match(/[0-9]/)?"number":(i.eatWhile(/[\w-]/),null)}(i,o)}}}),e.defineMIME("text/gmn","guido")});
class GuidoSettings{constructor(s){this.fEngine=s,this.initialize(),this.setDefault()}refresh(){this.fEngine.resfresh()}get settings(){return this.fEngine.settings}setDefault(){this.fEngine.setDefaultSettings(),this.display(),$("#hideslurs").prop("checked",!1),$("#hidedyn").prop("checked",!1),$("#hideart").prop("checked",!1),$("#hidetext").prop("checked",!1),$("#hidelyrics").prop("checked",!1),this.refresh()}moveLinked(s,i,e){var t=$(s).val();return $(e).val(t),i?t/i:t}setColor(){this.fEngine.color=this.color}get color(){var s=$("#score-color").val(),i=s.substring(1,3),e=s.substring(3,5),t=s.substring(5);return{r:parseInt(i,16),g:parseInt(e,16),b:parseInt(t,16)}}display(){$("#spring-slider").val(Math.round(100*this.settings.spring)),$("#spring-num").val(Math.round(100*this.settings.spring)),$("#force-slider").val(this.settings.force),$("#force-num").val(this.settings.force),$("#check-lyrics").prop("checked",!!this.settings.checkLyricsCollisions),$("#sysdist-slider").val(this.settings.systemsDistance),$("#sysdist-num").val(this.settings.systemsDistance),$("#sys-dist").prop("selectedIndex",this.settings.systemsDistribution-1),$("#maxdist-slider").val(Math.round(100*this.settings.systemsDistribLimit)),$("#maxdist-num").val(Math.round(100*this.settings.systemsDistribLimit)),$("#optpagefill").prop("checked",!!this.settings.optimalPageFill),$("#neighborhood").prop("checked",!!this.settings.neighborhoodSpacing),$("#resize").prop("checked",!!this.settings.resizePage2Music)}range(s,i){var e=parseInt(s),t=parseInt(i),r=new Array;if(isNaN(e))return r;if(r.push(e++),isNaN(t))return r;for(;e<=t;)r.push(e++);return r}list(s,i){var e=parseInt(s),t=new Array;if(isNaN(e))return t;t.push(e);var r=i.search(",");if(r>0)return t.push(...this.list(i.substr(0,r).trim(),i.substr(r+1).trim())),t;var h=parseInt(i);return isNaN(h)||t.push(h),t}get pages(){var s,i=$("#pages").val();if((s=i.search("-"))>0)return this.range(i.substr(0,s).trim(),i.substr(s+1).trim());if((s=i.search(","))>0)return this.list(i.substr(0,s).trim(),i.substr(s+1).trim());var e=parseInt(i.trim()),t=new Array;return isNaN(e)?t:(t.push(e),t)}get proll(){return this.fEngine.fPRoll}get spr(){return this.fEngine.fSPR}pageControl(s){$("#pages").prop("disabled",s),$("#pages").css("color",s?"#888888":"#000000")}initialize(){$("#spring-slider").mousedown(s=>{this.settings.spring=this.moveLinked("#spring-slider",100,"#spring-num"),this.refresh()}),$("#spring-slider").mousemove(s=>{this.settings.spring=this.moveLinked("#spring-slider",100,"#spring-num"),this.refresh()}),$("#spring-num").keyup(s=>{this.settings.spring=this.moveLinked("#spring-slider",100,"#spring-slider"),this.refresh()}),$("#spring-num").click(s=>{this.settings.spring=this.moveLinked("#spring-slider",100,"#spring-slider"),this.refresh()}),$("#force-slider").mousedown(s=>{this.settings.force=this.moveLinked("#force-slider",1,"#force-num"),this.refresh()}),$("#force-slider").mousemove(s=>{this.settings.force=this.moveLinked("#force-slider",1,"#force-num"),this.refresh()}),$("#force-num").keyup(s=>{this.settings.force=this.moveLinked("#force-num",1,"#force-slider"),this.refresh()}),$("#force-num").click(s=>{this.settings.force=this.moveLinked("#force-num",1,"#force-slider"),this.refresh()}),$("#check-lyrics").click(s=>{this.settings.checkLyricsCollisions=!!$("#force-slider").is(":checked"),this.refresh()}),$("#sysdist-slider").mousedown(s=>{this.settings.systemsDistance=this.moveLinked("#sysdist-slider",100,"#sysdist-num"),this.refresh()}),$("#sysdist-slider").mousemove(s=>{this.settings.systemsDistance=this.moveLinked("#sysdist-slider",100,"#sysdist-num"),this.refresh()}),$("#sysdist-num").keyup(s=>{this.settings.systemsDistance=this.moveLinked("#sysdist-num",100,"#sysdist-slider"),this.refresh()}),$("#sysdist-num").click(s=>{this.settings.systemsDistance=this.moveLinked("#sysdist-num",100,"#sysdist-slider"),this.refresh()}),$("#maxdist-slider").mousedown(s=>{this.settings.systemsDistribLimit=this.moveLinked("#maxdist-slider",100,"#maxdist-num"),this.refresh()}),$("#maxdist-slider").mousemove(s=>{this.settings.systemsDistribLimit=this.moveLinked("#maxdist-slider",100,"#maxdist-num"),this.refresh()}),$("#maxdist-num").keyup(s=>{this.settings.systemsDistribLimit=this.moveLinked("#maxdist-num",100,"#maxdist-slider"),this.refresh()}),$("#maxdist-num").click(s=>{this.settings.systemsDistribLimit=this.moveLinked("#maxdist-num",100,"#maxdist-slider"),this.refresh()}),$("#sys-dist").change(s=>{this.settings.systemsDistribution=$("#sys-dist :selected").index()+1,this.refresh()}),$("#optpagefill").click(s=>{this.settings.optimalPageFill=$("#optpagefill").is(":checked")?1:0,this.refresh()}),$("#neighborhood").click(s=>{this.settings.neighborhoodSpacing=$("#neighborhood").is(":checked")?1:0,this.refresh()}),$("#resize").click(s=>{this.settings.resizePage2Music=$("#resize").is(":checked")?1:0,this.refresh()}),$("#score-color").on("input",()=>{this.moveLinked("#score-color",0,"#score-color-num"),this.setColor()}),$("#score-color-num").keyup(()=>{this.moveLinked("#score-color-num",0,"#score-color"),this.setColor()}),$("#hideslurs").click(s=>{this.fEngine.showElement(1,!$("#hideslurs").is(":checked"))}),$("#hidedyn").click(s=>{this.fEngine.showElement(2,!$("#hidedyn").is(":checked"))}),$("#hideart").click(s=>{this.fEngine.showElement(3,!$("#hideart").is(":checked"))}),$("#hidetext").click(s=>{this.fEngine.showElement(4,!$("#hidetext").is(":checked"))}),$("#hidelyrics").click(s=>{this.fEngine.showElement(5,!$("#hidelyrics").is(":checked"))}),$("#default-settings").click(()=>{this.setDefault()}),$("#allpages").click(()=>{this.pageControl(!0),this.fEngine.showAll()}),$("#somepages").click(()=>{this.pageControl(!1),this.fEngine.showPages(this.pages)}),$("#lastpages").click(()=>{this.pageControl(!0),this.fEngine.showLast()}),$("#pages").keyup(()=>{this.fEngine.showPages(this.pages)}),$("#allpages").is(":checked")?(this.pageControl(!0),this.fEngine.showAll()):$("#somepages").is(":checked")?(this.pageControl(!1),this.fEngine.showPages(this.pages)):$("#lastpages").is(":checked")&&(this.pageControl(!0),this.fEngine.showLast()),$("#showkbd").click(()=>{this.proll.showKbd($("#showkbd").is(":checked"))}),$("#showbars").click(()=>{this.proll.showBars($("#showbars").is(":checked"))}),$("#prollcolor").click(()=>{this.proll.showColors($("#prollcolor").is(":checked"))}),$("#prolllines").click(()=>{this.proll.hideLines($("#prolllines").is(":checked"))}),this.proll.showKbd($("#showkbd").is(":checked")),this.proll.showBars($("#showbars").is(":checked")),this.proll.showColors($("#prollcolor").is(":checked")),this.proll.hideLines($("#prolllines").is(":checked")),$("#sprbars").click(()=>{this.spr.showBars($("#sprbars").is(":checked"))}),$("#sprcolor").click(()=>{this.spr.showColors($("#sprcolor").is(":checked"))}),$("#sprlines").click(()=>{this.spr.hideLines($("#sprlines").is(":checked"))}),this.spr.showBars($("#sprbars").is(":checked")),this.spr.showColors($("#sprcolor").is(":checked")),this.spr.hideLines($("#sprlines").is(":checked"))}}
"use strict";class GuidoEditor{constructor(t,e){this.fEditor=CodeMirror.fromTextArea(document.getElementById(t),{lineNumbers:!0,mode:"guido",theme:"default",smartIndent:!0,tabSize:4,lineWrapping:!0,indentWithTabs:!0,matchBrackets:!0,autoCloseBrackets:!0}),this.initialize(e)}initialize(t){this.fEditor.on("change",(e,i)=>{t.process(this.value)}),this.fEditor.on("dragstart",(t,e)=>{}),this.fEditor.on("dragenter",(t,e)=>{$("#editor").css("opacity",.3)}),this.fEditor.on("dragleave",(t,e)=>{$("#editor").css("opacity",1)}),this.fEditor.on("drop",(t,e)=>{if($("#editor").css("opacity",1),!e.dataTransfer.getData("text")){e.stopPropagation(),e.preventDefault();let t=e.dataTransfer.files;if(!t)return;let i=t.length;for(let e=0;e<i;e++)this.drop(t[e])}}),$("#font-family").change(t=>{this.fEditor.getWrapperElement().style["font-family"]=$("#font-family").val()}),$("#font-size").change(t=>{this.fEditor.getWrapperElement().style["font-size"]=$("#font-size").val()+"px",console.log("font change")}),$("#etheme").change(t=>{this.fEditor.setOption("theme",$("#etheme").val())}),$("#wraplines").change(t=>{this.fEditor.setOption("lineWrapping",$("#wraplines").is(":checked"))}),this.fEditor.getWrapperElement().style["font-family"]=$("#font-family").val(),this.fEditor.getWrapperElement().style["font-size"]=$("#font-size").val()+"px",this.fEditor.setOption("theme",$("#etheme").val()),this.fEditor.setOption("lineWrapping",$("#wraplines").is(":checked"))}setGmn(t,e){$("#gmn-name").text(e);var i=e.substr(e.lastIndexOf(".")+1).toLowerCase();"xml"!==i&&"musicxml"!==i||(t=lxml.string2guido(t,!0)),this.fEditor.setValue(t),this.fEditor.refresh()}drop(t){let e=new FileReader;e.onload=i=>{this.setGmn(e.result,t.name)},e.readAsText(t)}select(t,e){this.fEditor.setSelection({line:t,ch:e-1},{line:t,ch:e})}resize(t){$("div.CodeMirror").css("height",t)}get value(){return this.fEditor.getValue()}}
"use strict";class GuidoAltView{constructor(s,t,i,e){this.fEngine=s,this.fID=0,this.fDelete=i,this.fProcess=e,this.fDiv=t,this.fBars=!1,this.fColors=!1,this.fLines=!1}get svg(){return this.fID?this.fEngine.svgExport(this.fID,1024,512):""}get html(){var s='<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"></head>\n';return s+="<style>\ndiv { margin: 20px; padding: 30px; background-color: #efefef; border-radius: 10px; }\n</style>\n",s+="<body><div>\n",s+=$(this.fDiv).html(),s+="</div></body></html>\n"}set id(s){this.fID=s}showBars(s){this.fBars=s,this.display()}showColors(s){this.fColors=s,this.display()}hideLines(s){this.fLines=s,this.display()}setupEngine(){this.fEngine.enableMeasureBars(this.fID,this.fBars),this.fEngine.enableAutoVoicesColoration(this.fID,this.fColors)}display(){this.fID&&(this.setupEngine(),$(this.fDiv).html(this.svg))}process(s){this.destroy(),this.id=this.fProcess(s),this.display()}destroy(){this.fID&&this.fDelete(this.fID),this.fID=0}clear(){this.destroy(),$(this.fDiv).html("")}}class GuidoPRoll extends GuidoAltView{constructor(s){super(s,"#proll",t=>s.destroyPianoRoll(t),t=>s.ar2PianoRoll(0,t)),this.fKbd=!1}showKbd(s){this.fKbd=s,this.display()}setupEngine(){this.fEngine.enableKeyboard(this.fID,this.fKbd),this.fEngine.setPitchLinesDisplayMode(this.fID,this.fLines?-1:0),super.setupEngine()}}class GuidoSPR extends GuidoAltView{constructor(s){super(s,"#spr",t=>s.destroyRProportional(t),t=>s.ar2RProportional(t)),this.fLines=!0}setupEngine(){this.fEngine.drawDurationLines(this.fID,this.fLines),super.setupEngine()}}
"use strict";function download(t,i){var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(i)),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}function xmlversion(t){console.log("LibMusicXML version "+t.libVersionStr()),$("#lxmlversion").html(t.libVersionStr()),console.log("MusicXML to GMN converter version "+t.musicxml2guidoVersionStr()),$("#xml2guidoversion").html(t.musicxml2guidoVersionStr())}class GuidoCompiler{constructor(){this.fEngine=0,this.fMusicxml=0,this.fPRoll=0,this.fSPR=0,this.fParser=0,this.fAR=0,this.fGR=0,this.fCurrentSettings=0,this.fEditor=0,this.fColor={r:0,g:0,b:0},this.fDrawTime=0,this.fPages=0,this.fPagesMode="all",$("#savegmn").click(t=>{this.saveGMN()}),$("#savesvg").click(t=>{this.saveSVG()}),$("#savehtml").click(t=>{this.saveHTML()}),$("#savesvgproll").click(t=>{this.saveSVGPRoll()}),$("#savehtmlproll").click(t=>{this.saveHTMLPRoll()}),$("#savesvgspr").click(t=>{this.saveSVGPSPR()}),$("#savehtmlspr").click(t=>{this.saveHTMLSPR()})}initialize(t){var i=GuidoModule();i.onRuntimeInitialized=()=>{this.fEngine=new i.GuidoEngineAdapter;var t=this.fEngine.getVersion();console.log("Guido Engine version "+t.str),$("#version").html(t.str),this.fEngine.init(),this.fParser=this.fEngine.openParser(),this.fCurrentSettings=this.fEngine.getDefaultLayoutSettings(),this.fPRoll=new GuidoPRoll(new i.GUIDOPianoRollAdapter),this.fSPR=new GuidoSPR(new i.GUIDOReducedProportionalAdapter),this.fEditor=new GuidoEditor("code",this);var s=new GuidoSettings(this);this.fColor=s.color,this.scanUrl(),this.process(this.fEditor.value)}}svg(t,i=!0){return this.fGR?this.fEngine.gr2SVGColored(this.fGR,t,this.fColor.r,this.fColor.g,this.fColor.b,i):""}displayPage(t,i){return t=Math.max(t,1),t=Math.min(t,this.pageCount),$('<div class="page well">'+this.svg(t,i)+"</div>").appendTo("#score"),this.fEngine.getOnDrawTime(this.fGR)}displayList(t){this.fDrawTime=0,$("#score").html("");var i=!0;t.forEach(t=>{this.fDrawTime+=this.displayPage(t,i),i=!1}),this.showTime(),this.fEditor.resize($("#score").height())}displayPages(t,i){t=Math.max(t,1),i=Math.min(i,this.pageCount),this.fDrawTime=0,$("#score").html("");for(var s=t;s<=i;s++)$('<div class="page well">'+this.svg(s)+"</div>").appendTo("#score"),this.fDrawTime+=this.fEngine.getOnDrawTime(this.fGR);this.showTime(),this.fEditor.resize($("#score").height())}display(){if(this.fGR)switch(this.fPagesMode){case"pages":this.displayList(this.fPages);break;case"last":this.displayPages(this.pageCount,this.pageCount);break;case"all":default:this.displayPages(1,this.pageCount)}}ar2gr(t){t&&(this.fGR&&this.fEngine.freeGR(this.fGR),this.fGR=this.fEngine.ar2grSettings(t,this.fCurrentSettings),this.display(),this.fPRoll.process(t),this.fSPR.process(t))}process(t){if(t&&t.trim())if(this.fAR&&this.fEngine.freeAR(this.fAR),this.fAR=this.fEngine.string2AR(this.fParser,t),this.fAR)this.ar2gr(this.fAR),$("#gmn-error").text("");else{var i=this.fEngine.parserGetErrorCode(this.fParser);$("#gmn-error").text(i.msg+" line "+i.line+" col "+i.col),$("#gmn-error").click(()=>{this.fEditor.select(i.line-1,i.col-1)})}else this.clear()}resfresh(){this.ar2gr(this.fAR)}setDefaultSettings(){this.fCurrentSettings=this.fEngine.getDefaultLayoutSettings(),this.fCurrentSettings.optimalPageFill=!1}scanUrl(){var t=window.location.search.substring(1),i=t.search("=");if(i>=0){var s=t.substr(0,i),e=t.substr(i+1);switch(s){case"code":this.fEditor.setGmn(atob(e),"");break;case"src":var n=new XMLHttpRequest;n.onload=()=>{this.fEditor.setGmn(n.responseText,e)},n.open("get",e,!0),n.send()}}}showAll(){this.fPagesMode="all",this.display()}showLast(){this.fPagesMode="last",this.display()}showPages(t){this.fPagesMode="pages",this.fPages=t,this.display()}showElement(t,i){this.fGR&&(this.fEngine.showElement(this.fGR,t,i),this.display(this.pageCount))}showTime(){var t=this.fEngine.getParsingTime(this.fAR),i=this.fEngine.getAR2GRTime(this.fGR);$("#ptime").html(t),$("#agtime").html(t),$("#dtime").html(this.fDrawTime),$("#ttime").html(t+i+this.fDrawTime)}clear(){this.fAR&&this.fEngine.freeAR(this.fAR),this.fGR&&this.fEngine.freeGR(this.fGR),this.fAR=0,this.fGR=0,this.fPRoll.clear(),$("#gmn-name").text(""),$("#score").html(""),$("#spr").html(""),$("#gmn-error").text("")}setGmn(t,i){this.fEditor.setGmn(t,i)}saveGMN(){download(this.filename+".gmn",this.fEditor.value)}saveHTML(){download(this.filename+".html",this.html)}saveSVGPRoll(){download(this.filename+".pianoroll.svg",this.fPRoll.svg)}saveHTMLPRoll(){download(this.filename+".pianoroll.html",this.fPRoll.html)}saveSVGPSPR(){download(this.filename+".spr.svg",this.fSPR.svg)}saveHTMLSPR(){download(this.filename+".spr.html",this.fSPR.html)}saveSVG(){var t=this.pageCount;if(1==t)download(this.filename+".svg",this.svg(1));else for(var i=1;i<=t;i++){download(this.filename+"-page"+i+".svg",this.svg(i))}}get settings(){return this.fCurrentSettings}get filename(){var t=$("#gmn-name").text();return t&&t.trim()?(t=t.replace(/.*\//,"")).replace(/\.gmn$/,""):"untitled"}get html(){var t='<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8">\n';return t+='<link rel="stylesheet" href="http://guidoeditor.grame.fr/font/stylesheet.css" type="text/css" /></head>\n',t+="<style>\n.page { margin: 20px; padding: 20px; background-color: #efefef;}\n.well { border-radius: 10px; }\n</style>\n",t+="<body><div>\n",t+=$("#score").html(),t+="</div></body></html>\n"}get pageCount(){return this.fGR?this.fEngine.getPageCount(this.fGR):0}set color(t){this.fColor=t,this.display(this.pageCount)}}const guidoEditor=new GuidoCompiler;guidoEditor.initialize(guidoEditor);const lxml=new libmusicxml;lxml.initialize().then(xmlversion);
